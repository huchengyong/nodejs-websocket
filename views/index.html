<!DOCTYPE html>
<!-- saved from url=(0071)http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html -->
<html class="js cssanimations"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		
		<title>nodejs+websocket实现聊天功能</title>
		<link rel="stylesheet" href="./css/amazeui.min.css">
		<link rel="stylesheet" href="./css/main.css">
	</head>
	<body style="">
		<div class="box">
			<div class="wechat">
				
				<div class="sidestrip">
					<div class="am-dropdown" data-am-dropdown="">
						<!--头像插件-->
						<div class="own_head am-dropdown-toggle"></div>
						<div class="am-dropdown-content">
					    	<div class="own_head_top">
					    		<div class="own_head_top_text">
					    			<p class="own_name"><span><%= info.username %></span><img src="<%= info.headimg %>" alt=""></p>
					    			<p class="own_numb">微信号：jsk8787682</p>
					    		</div>
					    		<img src="<%= info.headimg %>" alt="">
					    	</div>
					    	<div class="own_head_bottom">
					    		<p><span>地区</span>江西 九江</p>
					    		<div class="own_head_bottom_img">
					    			<a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./images/head_1.png"></a>
					    			<a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./images/head_2.png"></a>
					    		</div>
					    	</div>
					  	</div>
					</div>
					<!--三图标-->
				  	<div class="sidestrip_icon">
				  		<a id="si_1" style="background: url(./images/icon/head_2_1.png) no-repeat;"></a>
				  		<a id="si_2"></a>
				  		<a id="si_3"></a>
				  	</div>
				  	
				  	<!--底部扩展键-->
				  	<div id="doc-dropdown-justify-js">
				  		<div class="am-dropdown" id="doc-dropdown-js" style="position: initial;">
					  		<div class="sidestrip_bc am-dropdown-toggle"></div>
					  	    <ul class="am-dropdown-content" style="min-width: 60px;">
							    <li>
							    	<a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html#" data-am-modal="{target: &#39;#doc-modal-1&#39;, closeViaDimmer: 0, width: 400, height: 225}">意见反馈</a>
							    	<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
									  <div class="am-modal-dialog">
									    <div class="am-modal-hd">Modal 标题
									      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close="">×</a>
									    </div>
									    <div class="am-modal-bd">
									      Modal 内容。本 Modal 无法通过遮罩层关闭。
									    </div>
									  </div>
									</div>
							    </li>
							    
							    <li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html#">备份与恢复</a></li>
							    <li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html#">设置</a></li>
						    </ul>
					    </div>	
					</div>	
				</div>
				
				<!--聊天列表-->
				<div class="middle on">
					<div class="wx_search">
						<input type="text" placeholder="搜索">
						<button>+</button>
					</div>
					<div class="office_text" style="overflow: hidden;">
						<ul class="user_list" style="top: 0px; position: absolute;">
							<% for(var i=0;i < friends.length;i++){ %>
							<% if(i == 0){ %>
								<li class="user_active" data-id="<%= friends[i].id %>">
							<% }else{ %>
								<li data-id="<%= friends[i].id %>">
							<% } %>
								<div class="user_head"><img src="<%= friends[i].headimg %>"></div>
								<div class="user_text">
									<p class="user_name"><%= friends[i].username %></p>
									<p class="user_message">我是傻逼！，金少凯牛逼！</p>
								</div>
								<div class="user_time">下午 2：54</div>
							</li>
							<% } %>
							<!-- <li>
								<div class="user_head"><img src="./images/5.jpg"></div>
								<div class="user_text">
									<p class="user_name">订阅号</p>
									<p class="user_message">庐山国际水彩艺术节：</p>
								</div>
								<div class="user_time">星期三</div>
							</li> -->
						</ul>
					<div style="position: absolute; display: block; line-height: 0; height: 610px;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: block; line-height: 0; height: 491px; top: 4px;" class="zUIpanelScrollBar"></div></div>	
				</div>
			    
			    <!--好友列表-->
				<div class="middle">
					<div class="wx_search">
						<input type="text" placeholder="搜索">
						<button>+</button>
					</div>
					<div class="office_text" style="overflow: hidden;">
						<ul class="friends_list" style="top: 0px; position: absolute;">
							<li>
								<p>新的朋友</p>
								<div class="friends_box">
									<div class="user_head"><img src="./images/1.jpg"></div>
									<div class="friends_text">
										<p class="user_name">新的朋友</p>
									</div>
								</div>
							</li>
							<li>
								<p>公众号</p>
								<div class="friends_box">
									<div class="user_head"><img src="./images/2.jpg"></div>
									<div class="friends_text">
										<p class="user_name">公众号</p>
									</div>
								</div>
							</li>
							<li>
								<p>A</p>
								<div class="friends_box">
									<div class="user_head"><img src="./images/3.jpg"></div>
									<div class="friends_text">
										<p class="user_name">彭于晏丶plus</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./images/4.jpg"></div>
									<div class="friends_text">
										<p class="user_name">陈依依</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./images/5.jpg"></div>
									<div class="friends_text">
										<p class="user_name">毛毛</p>
									</div>
								</div>
							</li>
							<li>
								<p>B</p>
								<div class="friends_box">
									<div class="user_head"><img src="./images/6.jpg"></div>
									<div class="friends_text">
										<p class="user_name">苏笑言</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./images/7.jpg"></div>
									<div class="friends_text">
										<p class="user_name">往事不再提</p>
									</div>
								</div>
							</li>
							<li>
								<p>C</p>
								<div class="friends_box">
									<div class="user_head"><img src="./images/8.jpg"></div>
									<div class="friends_text">
										<p class="user_name">夏继涛</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./images/9.jpg"></div>
									<div class="friends_text">
										<p class="user_name">早安无恙</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./images/10.jpg"></div>
									<div class="friends_text">
										<p class="user_name">王鹏</p>
									</div>
								</div>
							</li>
							<li>
								<p>D</p>
								<div class="friends_box">
									<div class="user_head"><img src="./images/11.jpg"></div>
									<div class="friends_text">
										<p class="user_name">涨了潮了</p>
									</div>
								</div>
								<div class="friends_box">
									<div class="user_head"><img src="./images/12.jpg"></div>
									<div class="friends_text">
										<p class="user_name">Ktz丶中融资</p>
									</div>
								</div>
							</li>
						</ul>
					<div style="position:absolute;display:none;line-height:0;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: none; line-height: 0;" class="zUIpanelScrollBar"></div></div>	
				</div>
				
				<!--程序列表-->
				<div class="middle">
					<div class="wx_search">
						<input type="text" placeholder="搜索收藏内容">
						<button>+</button>
					</div>
					<div class="office_text" style="overflow: hidden;">
						<ul class="icon_list" style="top: 0px; position: absolute;">
							<li class="icon_active">
								<div class="icon"><img src="./images/icon.png" alt=""></div>
								<span>全部收藏</span>
							</li>
							<li>
								<div class="icon"><img src="./images/icon1.png" alt=""></div>
								<span>链接</span>
							</li>
							<li>
								<div class="icon"><img src="./images/icon2.png" alt=""></div>
								<span>相册</span>
							</li>
							<li>
								<div class="icon"><img src="./images/icon3.png" alt=""></div>
								<span>笔记</span>
							</li>
							<li>
								<div class="icon"><img src="./images/icon4.png" alt=""></div>
								<span>文件</span>
							</li>
							<li>
								<div class="icon"><img src="./images/icon5.png" alt=""></div>
								<span>音乐</span>
							</li>
							<li>
								<div class="icon"><img src="./images/icon6.png" alt=""></div>
								<span>标签</span>
							</li>
						</ul>
					<div style="position:absolute;display:none;line-height:0;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: none; line-height: 0;" class="zUIpanelScrollBar"></div></div>	
				</div>
			
				<!--聊天窗口-->
				<div class="talk_window">
					<div class="windows_top">
						<div class="windows_top_box">
							<span id="current_user"><%= toinfo.username %></span>
							<ul class="window_icon">
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./images/icon7.png"></a></li>
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./images/icon8.png"></a></li>
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./images/icon9.png"></a></li>
								<li><a href="http://www.17sucai.com/preview/776331/2018-07-23/AmazeWeixin/index.html"><img src="./images/icon10.png"></a></li>
							</ul>
							<div class="extend" data-am-offcanvas="{target: &#39;#doc-oc-demo3&#39;}"></div>
							<!-- 侧边栏内容 -->
							<div id="doc-oc-demo3" class="am-offcanvas">
							    <div class="am-offcanvas-bar am-offcanvas-bar-flip">
								    <div class="am-offcanvas-content">
								    	<p><a href="http://music.163.com/#/song?id=385554" target="_blank">网易音乐</a></p>
								    </div>
							    </div>
							</div>
						</div>
					</div>
					
					<!--聊天内容-->
					<div class="windows_body">
						<div class="office_text" style="height: 100%; overflow: hidden;">
							<ul class="content" id="chatbox" style="top: 0px; position: absolute;">
								<% for(var i = 0;i < records.length;i++){ %>
									<% if(records[i].from_uid == info.id){ %>
										<li class="me"><img src="<%= info.headimg %>" title="<%= info.username %>"><span><%= records[i].content %></span></li>
									<% }else if(records[i].to_uid == info.id){ %>
										<li class="other"><img src="<%= toinfo.headimg %>" title="<%= toinfo.username %>"><span><%= records[i].content %></span></li>
									<% } %>
								<% } %>
							</ul>
						<div style="position: absolute; display: none; line-height: 0; height: 0px;" class="zUIpanelScrollBox"></div><div style="position: absolute; display: none; line-height: 0; height: 0px;" class="zUIpanelScrollBar"></div></div>
					</div>
					
					<div class="windows_input" id="talkbox" style="">
						<div class="input_icon">
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
							<a href="javascript:;"></a>
						</div>
						<div class="input_box">
							<textarea name="" rows="" cols="" id="input_box" style=""></textarea>
							<button id="send">发送（S）</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	<script type="text/javascript" src="./js/jquery.min.js"></script>
	<script type="text/javascript" src="./js/amazeui.min.js"></script>
	<script type="text/javascript" src="./js/zUI.js"></script>
	<script type="text/javascript" src="./js/wechat.js?a=2"></script>
	<script type="text/javascript">
		var websocket = null;
		var user = {};
		var chat = document.getElementById('chatbox');
		user.userid = <%= info.id %>;
		user.username = $('.own_name').find('span').text();
		user.headimg = $('.own_name').find('img').prop('src');
		if('WebSocket' in window){
			websocket = new WebSocket("ws://182.61.13.2:3000/");
		}else{
			alert('您的浏览器不支持WebSocket');
		}
		websocket.onopen = function(e){
			user.type = 'enter';
			user.touserid = $('.user_active').attr('data-id');
			websocket.send(JSON.stringify(user));
		}

		websocket.onmessage = function(e){
			var obj = JSON.parse(e.data);
			console.log(obj);
			if(obj.uid == user.userid){
				createChat(obj,true);
			}else{
				createChat(obj,false);
			}
		}

		websocket.onclose = function(){
			console.log('WebSocket closed');
		}

		websocket.onerror = function(){
			console.log('websocket error');
		}

		window.onbeforeunload = function(){
			websocket.close();
		}

		$(".user_list").find('li').click(function(){
			user.type = 'enter';
			user.touserid = $(this).attr('data-id');
			user.toheadimg = $(this).find('.user_head').find('img').prop('src');
			user.tousername = $(this).find('.user_text').find('.user_name').text();

			$('#current_user').text(user.tousername);

			websocket.send(JSON.stringify(user));
			$(this).siblings('li').removeClass('user_active');
			$(this).addClass('user_active');
			$.post('/getRecords',{from_uid:user.userid,to_uid:user.touserid},function(result){
				var result = JSON.parse(result);
				var li = '';
				for(var i = 0;i < result.length;i++){
					if(result[i].from_uid == user.userid){
						li += '<li class="me"><img src="'+user.headimg+'" title="'+user.username+'"><span>'+result[i].content+'</span></li>';
					}else if(result[i].to_uid == user.userid){
						li += '<li class="other"><img src="'+user.toheadimg+'" title="'+user.tousername+'"><span>'+result[i].content+'</span></li>';
					}
				}
				$('.content').html(li);
			})
		})

		$("#send").click(function(){
			getValues();
		})

		$(document).keyup(function(event){
			if(event.ctrlKey && event.which == 13){
				getValues();
			}
		})

		function getValues(){
			if($("#input_box").val() == ''){
				alert('聊天内容不能为空');
				return;
			}
			user.touserid = $('.user_active').attr('data-id');
			user.toheadimg = $('.user_active').find('.user_head').find('img').prop('src');
			user.tousername = $('.user_active').find('.user_text').find('.user_name').text();
			user.data = $("#input_box").val();
			user.type = 'chat';
			$("#input_box").val('');
			chat.scrollTop = chat.scrollHeight;
			websocket.send(JSON.stringify(user));
		}

		function createChat(obj,ismine){
			if(obj.data != undefined && obj.data != ''){
				var $li;
				$('.user_list').find('li').each(function(id,item){
					var whose = $('.user_active').attr('data-id');
					//未解决,消息在其他好友对话框下收到,还有数据库名更改
					if(whose == obj.touserid){
						if(ismine && obj.type != 'enter'){
							$li = '<li class="me"><img src="'+obj.headimg+'" title="'+obj.username+'"><span>'+obj.data+'</span></li>';
						}else{
							$li = '<li class="other"><img src="'+obj.headimg+'" title="'+obj.username+'"><span>'+obj.data+'</span></li>';
						}
					}
				})
				$('.content').append($li);
			}
			chat.scrollTop = chat.scrollHeight;
		}
	</script>
	<script type="text/javascript">
		//三图标
		window.onload=function(){
			function a(){
				var si1 = document.getElementById('si_1');
				var si2 = document.getElementById('si_2');
				var si3 = document.getElementById('si_3');
				si1.onclick=function(){
					si1.style.background="url(images/icon/head_2_1.png) no-repeat"
					si2.style.background="";
					si3.style.background="";
				};
				si2.onclick=function(){
					si2.style.background="url(images/icon/head_3_1.png) no-repeat"
					si1.style.background="";
					si3.style.background="";
				};
				si3.onclick=function(){
					si3.style.background="url(images/icon/head_4_1.png) no-repeat"
					si1.style.background="";
					si2.style.background="";
				};
			};
			function b(){
				var text = document.getElementById('input_box');
				var chat = document.getElementById('chatbox');
				var btn = document.getElementById('send');
				var talk = document.getElementById('talkbox');
				// btn.onclick=function(){
				// 	if(text.value ==''){
			 //            alert('不能发送空消息');
			 //        }else{
				// 		chat.innerHTML += '<li class="me"><img src="'+'images/own_head.jpg'+'"><span>'+text.value+'</span></li>';
				// 		text.value = '';
				// 		chat.scrollTop=chat.scrollHeight;
				// 		talk.style.background="#fff";
				// 		text.style.background="#fff";
				// 	};
				// };
			};
			a();
			b();
		};
	</script>
	

</body></html>